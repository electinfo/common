apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: common-npm-publish
  namespace: tekton-pipelines
spec:
  description: Build and publish TypeScript package to Nexus npm registry
  workspaces:
    - name: source
      description: Workspace containing the source code
  steps:
    - name: publish
      image: node:20-alpine
      workingDir: $(workspaces.source.path)
      env:
        - name: NEXUS_USER
          valueFrom:
            secretKeyRef:
              name: nexus-credentials
              key: username
        - name: NEXUS_PASSWORD
          valueFrom:
            secretKeyRef:
              name: nexus-credentials
              key: password
      script: |
        #!/bin/sh
        set -e

        echo "=== Installing dependencies ==="
        npm install

        echo "=== Building TypeScript ==="
        npm run build

        echo "=== Configuring npm registry ==="
        # Use internal Nexus service URL to bypass Traefik (which blocks %2F in scoped package names)
        NEXUS_URL="http://nexus-nexus-repository-manager.nexus.svc.cluster.local:8081/repository/npm-hosted/"
        AUTH=$(echo -n "${NEXUS_USER}:${NEXUS_PASSWORD}" | base64)
        printf 'registry=%s\n//nexus-nexus-repository-manager.nexus.svc.cluster.local:8081/repository/npm-hosted/:_auth=%s\n//nexus-nexus-repository-manager.nexus.svc.cluster.local:8081/repository/npm-hosted/:always-auth=true\n' "${NEXUS_URL}" "${AUTH}" > .npmrc
        echo "=== .npmrc contents ==="
        cat .npmrc

        echo "=== Publishing to npm registry ==="
        npm publish

        echo "=== npm publish complete ==="
